class ThaiElementAssessment {
    constructor() {
        console.log('ThaiElementAssessment constructor called');
        this.questions = {
            "รสชาติอาหารที่ชอบ": {
        "ปิตตะ": "ชอบกินของร้อนๆ เผ็ด เปรี้ยว รสจัด อาหารเผ็ด(เครื่องเทศ เครื่องแกง)",
        "วาตะ": "ร้อน ฝาด ขม รสเค็ม",
        "เสมหะ": "เปรี้ยวหวาน"
    },
    "อาหาร": {
        "ปิตตะ": "ของดิบ อาหารบูดเน่า แอลกอฮอล์",
        "วาตะ": "กินเนื้อแห้ง ปลาแห้ง น้ำอัดลม", 
        "เสมหะ": "กินหวานมัน กินย้ำ กินหลากหลาย น้ำหวาน ขนมหวาน"
    },
    "การกิน": {
        "ปิตตะ": "กินทีละมากๆ กินเป็นมื้อๆ กินกลางคืน",
        "วาตะ": "กินบ่อย กินเก่ง หิวบ่อย",
        "เสมหะ": "กินน้อย กินเหลือ กินช้า"
    },
    "น้ำ": {
        "ปิตตะ": "ดื่มน้ำน้อย กระหายน้ำเย็น",
        "วาตะ": "ไม่ค่อยดื่มน้ำ ดื่มน้ำมาก",
        "เสมหะ": "ชอบน้ำอุ่น"
    },
    "อุจจาระ": {
        "ปิตตะ": "แข็งแห้ง ถ่ายลำบาก",
        "วาตะ": "ท้องผูก ถ่ายบ่อย ถ่ายไม่สุด",
        "เสมหะ": "อุจจาระปกติ ถ่ายวันละครั้ง"
    },
    "ปัสสาวะ": {
        "ปิตตะ": "ปัสสาวะร้อน สีเข้ม ฉี่น้อย",
        "วาตะ": "ปัสสาวะบ่อย ปริมาณน้อย กระปริบกระปรอย",
        "เสมหะ": "ปัสสาวะสีซีด ปัสสาวะกลางคืน ครั้งละมากๆ"
    },
    "ลักษณะการทำงาน": {
        "ปิตตะ": "ทำงานหนัก ใช้แรงงาน ทำงานกลางแจ้ง นักกีฬา คนออกกำลังกาย",
        "วาตะ": "ทำงานนิ่งๆ ทำงานนั่งโต๊ะ ไม่ค่อยได้ขยับ",
        "เสมหะ": "ทำงานเบาๆ พอดีๆ สบายๆ นั่งๆนอนๆ ทำงานห้องแอร์"
    },
    "อารมณ์": {
        "ปิตตะ": "อารมณ์เสีย โกรธง่าย โมโหง่าย มักโกรธเมื่อตะวันเที่ยง อากาศร้อน หงุดหงิดง่าย",
        "วาตะ": "คิดมาก คิดเยอะ ชอบดูแสงสีเสียง มักกล่าวเรื่องเศร้าโศก อารมณ์แปรปรวน",
        "เสมหะ": "อารมณ์ดี ยิ้มง่าย ชอบอารมณ์นิยมกลืน ใจเย็น คุยเก่ง อัธยาศัยดี"
    },
    "การพูดการคุย": {
        "ปิตตะ": "คุยใช้เหตุผล พูดจาหนักแน่น",
        "วาตะ": "คุยไร้สาระ เนื้อหาไม่เรียบเรียง พูดเร็ว",
        "เสมหะ": "พูดช้า"
    },
    "สมาธิ": {
        "ปิตตะ": "สมาธิจดจ่อ ทำงานละเอียด",
        "วาตะ": "สมาธิสั้น ทำอะไรไม่ได้นาน ย้ำคิดย้ำทำ ทำอะไรหลายอย่างในเวลาเดียวกัน",
        "เสมหะ": "สมาธิดี ทำงานได้นาน"
    },
    "อากาศ": {
        "ปิตตะ": "ชอบอยู่ที่ร้อนๆ",
        "วาตะ": "ชอบอยู่ที่ที่ลมพัด อากาศถ่ายเท",
        "เสมหะ": "ชอบอยู่ที่เย็นๆ ชื้นๆ"
    },
    "อาบน้ำ": {
        "ปิตตะ": "ชอบอาบน้ำร้อน อาบน้ำตอนกลางวันร้อนๆ ตอนกลางคืนดึกๆ",
        "วาตะ": "อาบน้ำเร็ว ไม่ค่อยอาบน้ำ",
        "เสมหะ": "ชอบแช่น้ำ เล่นน้ำ อาบน้ำนาน"
    },
    "การนอน": {
        "ปิตตะ": "นอนกลางวันมาก กลางคืนนอนไม่หลับ",
        "วาตะ": "กลางคืนไม่นอน ชอบคิดฟุ้งซ่าน หลับไม่สนิท",
        "เสมหะ": "ง่วงหงาวหาวนอนนัก นอนเยอะ หลับสนิท"
    },
    "ความฝัน": {
        "ปิตตะ": "ฝันน่ากลัว ผี ปีศาจ ไฟ ความร้อน",
        "วาตะ": "ฝันตื่นเต้น ฝันเยอะ ฝันว่าตกจากที่สูง",
        "เสมหะ": "ฝันดี ฝันว่าได้ว่ายน้ำนอนสระน้ำ เห็นของสวยๆงามๆ"
    },
    "ลักษณะร่างกาย": {
        "ปิตตะ": "ผิวแห้ง ร้อนหน้าร้อนปาก เหงื่อยออกน้อย ผิวไม่ผ่องใส",
        "วาตะ": "ผื่นลมพิษทั่วตัว แสบคัน ผิวดำไม่ผ่องใส",
        "เสมหะ": "มักเป็นตุ่ม ฝีกบวม เหงื่อออกมาก"
    }      
};

        this.clinical_symptoms = {
            "ปิตตะ": ["ร้อนใน", "ปากขม", "กระหายน้ำ", "โรคกระเพาะ", "กรดไหลย้อน", "ตับ", "ถุงน้ำดี", "ความดันโลหิตสูง", "ตาแห้ง", "เยื่อบุตาอักเสบ", "ไมเกรน"],
            "วาตะ": ["ปวดเมื่อยตามร่างกาย", "โรคทางเดินหายใจ", "หอบหืด", "ภูมิแพ้", "ท้องผูกท้องอืด", "แน่นท้อง", "ลำไส้แปรปรวน", "นอนไม่หลับ", "หลับไม่สนิท", "วิตกกังวล", "อารมณ์แปรปรวน", "โรคทางเดินอาหาร", "ข้อต่อกระดูก", "ปลายประสาทอักเสบ"],
            "เสมหะ": ["น้ำหนักเกิน", "อ้วน", "เบาหวาน", "ไขมัน", "อ่อนเพลีย ล้า เหนื่อยง่าย"]
        };

        this.scores = {"ปิตตะ": 0, "วาตะ": 0, "เสมหะ": 0};
        this.user_symptoms = [];
    }

    getQuestions() {
         console.log('getQuestions called');
        return this.questions;
    }

    getClinicalSymptoms() {
        console.log('getClinicalSymptoms called');
        return this.clinical_symptoms;
    }

    processAnswers(answers) {
        answers.forEach(element => {
            this.scores[element]++;
        });
    }

    determineDominantElement() {
        return Object.keys(this.scores).reduce((a, b) => this.scores[a] > this.scores[b] ? a : b);
    }

    processSymptoms(symptoms) {
        this.user_symptoms = symptoms;
    }

    analyzeCorrelation(dominant_element) {
        const total_score = Object.values(this.scores).reduce((a, b) => a + b, 0);
        const dominant_ratio = this.scores[dominant_element] / total_score;
        
        const total_symptoms = this.clinical_symptoms[dominant_element].length;
        const user_symptoms_count = this.user_symptoms.length;
        
        const symptom_ratio = total_symptoms > 0 ? user_symptoms_count / total_symptoms : 0;
        
        return (dominant_ratio + symptom_ratio) / 2;
    }

    getResults() {
        const dominant_element = this.determineDominantElement();
        const correlation = this.analyzeCorrelation(dominant_element);

        return {
            scores: this.scores,
            dominant_element: dominant_element,
            user_symptoms: this.user_symptoms,
            correlation: correlation,
            risk_level: this.getRiskLevel(correlation),
            explanation: this.getExplanation(correlation)
        };
    }

    getRiskLevel(correlation) {
        if (correlation <= 0.5) {
            return "ไม่มีความเสี่ยงที่ควรเฝ้าระวัง";
        } else if (correlation <= 0.8) {
            return "มีความเสี่ยงในระดับเฝ้าระวัง";
        } else {
            return "มีความเสี่ยงมาก โปรดพบแพทย์เพื่อประเมินเพิ่มเติม";
        }
    }

    getExplanation(correlation) {
        if (correlation <= 0.5) {
            return "ธาตุเด่นของคุณไม่มีความสัมพันธ์มากนักกับอาการทางคลินิกที่พบ คุณควรดูแลสุขภาพตามปกติและสังเกตอาการเปลี่ยนแปลงต่างๆ";
        } else if (correlation <= 0.8) {
            return "ธาตุเด่นของคุณมีความสัมพันธ์ในระดับปานกลางกับอาการทางคลินิกที่พบ คุณควรเฝ้าระวังและดูแลสุขภาพอย่างใกล้ชิด หากมีอาการรุนแรงขึ้น ควรปรึกษาแพทย์";
        } else {
            return "ธาตุเด่นของคุณมีความสัมพันธ์สูงกับอาการทางคลินิกที่พบ คุณควรพบแพทย์เพื่อรับการตรวจประเมินอย่างละเอียด อาจจำเป็นต้องได้รับการรักษาหรือการดูแลเฉพาะทาง";
        }
    }
}

module.exports = ThaiElementAssessment;
